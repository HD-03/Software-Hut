- status_class_mapping = {"completed" => "table-success", "todo" => "table-danger", "pending" => "table-warning"}

.row.h-100.justify-content-center.text-center
  .col-md-7.p-4
    .mx-auto
      %h2.pb-4.mb-0 Plan for the week
      - (Date.today.beginning_of_week..Date.today.end_of_week).each do |day|
        - today = day == Date.today
        - week_day = day.strftime("%A")
        .pb-3.accordion{id: "#{week_day}"}
          .accordion-item.rounded-3
            %h3.accordion-header
              %button.accordion-button.rounded-3{ class: today ? '' : 'collapsed', type: "button", data: { bs_toggle: "collapse", bs_target: "#collapse-#{week_day}", aria_expanded: today ? 'true' : 'false', aria_controls: "collapse-#{week_day}" } }
                = day.strftime("%A %-d %B")
            .accordion-collapse.collapse{ class: today ? 'show' : '', id: "collapse-#{week_day}", data: { bs_parent: "#{week_day}" } }
              .accordion-body
                - if @tasks.select { |task| task.deadline_day_this_week == week_day }.empty?
                  No tasks for this day
                - else
                  .table-responsive
                    %table.table
                      %thead
                        %tr
                          %th Task
                          %th Instrument 
                          %th Reward XP
                          %th Teacher
                          %th Status
                          %th
                      %tbody
                        - @tasks.select { |task| task.deadline_day_this_week == week_day }.each do |task|
                          %tr{ class: status_class_mapping[task.status.to_s] }
                            %td.align-middle
                              = task.name
                            %td.align-middle
                              = task.instrument.name
                            %td.align-middle
                              = task.reward_xp
                            %td.align-middle
                              = task.teacher.full_name
                            %td.align-middle.fs-4
                              - if task.status.to_s == "completed"
                                %i.bi.bi-check2-all
                              - elsif task.status.to_s == "pending"
                                %i.bi.bi-check2
                              - else
                                %i.bi.bi-clock-history

                            %td.align-middle
                              .btn-toolbar.float-end
                                - if task.status.to_s == "todo"
                                  = link_to 'Do', task_details_path(task), class: 'btn btn-outline-secondary btn-sm'

                                - else
                                  = link_to 'View', '#', class: 'btn btn-outline-secondary btn-sm'

  .col-md-5.p-4.text-white.d-flex.align-items-center
    .card.border-0.rounded-5.shadow-lg.text-center.mx-auto.mb-auto
      .my-auto.p-3
        .mb-3
          - if current_user.avatar.attached?
            = image_tag current_user.avatar.variant(:thumb), class: 'p-4 rounded-circle img-fluid'
          -# %img.p-4.rounded-circle.img-fluid{src: "https://via.placeholder.com/300x300"}
        .h3
          Level
          = current_user.level
        .progress.m-3
          .progress-bar{role: "progressbar", style: "width: #{current_user.get_current_level_progress}%", aria_valuenow: "#{current_user.get_current_level_progress}", aria_valuemin: "0", aria_valuemax: "100"}
        .--bs-success-text-emphasis  
          = current_user.xp_points  
          \/
          = current_user.xp_needed_for_next_level
          xp
        .btn.btn-primary.border-0.rounded-5.shadow-lg.py-2.px-3.ms-auto.my-4
          = link_to 'Change Avatar', '#', class: 'text-light link-underline link-underline-opacity-0'
        .btn.btn-primary.border-0.rounded-5.shadow-lg.py-2.px-3.ms-auto.my-4
          = link_to 'Level up (for demonstration)', student_give_student_xp_path(current_user.id), method: :post, class: 'text-light link-underline link-underline-opacity-0'
        
        -# ----------------------------------------------------------------------------------------------------------------------------------------
        %button#activateModal{"style" => "display: none;", "data-bs-target" => "#levelUpModal", "data-bs-toggle" => "modal", :type => "button"} Launch modal


  - if @show_level_up_modal
    -# this is potentially the dumbest implementation of anything in this module
    -# but this is the only way that activating this modal works, I have spent
    -# HOURS trying to make this work and this is the only thing that has, so
    -# just allow it.. thanks. It's not my fault that bootstrap is having so many
    -# issues with me using modals

    :javascript
      document.addEventListener('DOMContentLoaded', (event) => {
        document.getElementById('activateModal').click();
      });
    
    - current_user.update(recently_leveled_up: false)
  

  -# The code in this block i've seperated by the two lined comments is what activates
  -# the below modal congratulating the user of leveling up when a user has leveled up.
  -# The way it works is too complicated to try understanding.
  -# Esentially you just need to know it works.
  -# ----------------------------------------------------------------------------------------------------------------------------------------


  .modal.fade#levelUpModal(tabindex="-1" role="dialog" aria-labelledby="levelUpModalLabel" aria-hidden="true")
    .modal-dialog.modal-dialog-centered.modal-xl
      .modal-content
        .modal-header.p-3
          -# %h5.modal-title#levelUpModalLabel Congratulations
          %button.btn.btn-primary.border-0.rounded-5.shadow-lg.ms-auto.px-4.py-2(type="button" data-bs-dismiss="modal" aria-label="Close")
            Close
        
        .modal-body.h1.p-5.m-2
          %p Level #{current_user.level} reached
          
        .modal-footer.d-flex.flex-column.justify-content-center
          .h3.text-decoration-underline
            New avatars unlocked:
          .mt-3
            %img.p-4.rounded-circle.img-fluid.scaled-avatar-image{src: "https://via.placeholder.com/300x300"}
            %img.p-4.rounded-circle.img-fluid.scaled-avatar-image{src: "https://via.placeholder.com/300x300"}
            %img.p-4.rounded-circle.img-fluid.scaled-avatar-image{src: "https://via.placeholder.com/300x300"}
